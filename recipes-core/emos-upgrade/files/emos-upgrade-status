#!/bin/sh

#
# Copyright (C) 2018-2019, TQ Systems
#

set -e

FILE_LOCK="/update/lock"
FILE_UPDATE_STATUS="/update/status"
FILE_RAUC_SLOT_SAVED="/update/slot"


exec 9>"$FILE_LOCK"
flock 9


RAUC_SLOT_ACTIVE="$(rauc status --output-format=json | jq -r '.booted')"

get_slot_saved() {
	cat "$FILE_RAUC_SLOT_SAVED" 2>/dev/null || true
}

get_slot_active() {
	echo "$RAUC_SLOT_ACTIVE"
}

get_status() {
	cat "$FILE_UPDATE_STATUS" 2>/dev/null || true
}

check_transition() {
	local old_status="$(get_status)"

	if [ "$old_status" != "$1" ]; then
		echo >&2 "emos-upgrade-status: invalid transition from '$old_status' to '$2'. Is there another upgrade running?"
		exit 1
	fi
}

set_status() {
	[ $# -eq 1 -a ! -z "$1" ] || exit 1

	case "$1" in
	"update_1_started")
		check_transition '' "$1"
		logger -t emos-upgrade-status "Updating first rootfs. (currently running $RAUC_SLOT_ACTIVE)"
		echo "$RAUC_SLOT_ACTIVE" > "$FILE_RAUC_SLOT_SAVED"
		;;
	"update_1_finished")
		check_transition 'update_1_started' "$1"
		logger -t emos-upgrade-status "Updated first rootfs successfully. (currently running $RAUC_SLOT_ACTIVE)"
		;;
	*)
		echo >&2 'emos-upgrade-status: Cannot set unknown status.'
		exit 1
	esac

	echo "$1" > "$FILE_UPDATE_STATUS"
}

reset_status() {
	rm -f "$FILE_UPDATE_STATUS" "$FILE_RAUC_SLOT_SAVED"
}

CMD="$1"; shift

case "$CMD" in
set_status)
	set_status "$@"
	;;
get_status)
	get_status
	;;
get_slot_active)
	get_slot_active
	;;
get_slot_saved)
	get_slot_saved
	;;
reset)
	reset_status
	;;
*)
	echo >&2 'emos-upgrade-status: Unknown command.'
	exit 1
esac
